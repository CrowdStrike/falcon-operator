name: Operator Metadata Sanity

on:
  push:
    branches:
      - main
      - 'maint-*'
  pull_request:
    branches:
      - main
      - 'maint-*'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest]
        go-version: [1.18.x]

    runs-on: ${{ matrix.os }}
    steps:

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v3
      with:
        go-version: ${{ matrix.go-version }}
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Install dependencies
      uses: mstksg/get-package@master
      with:
        apt-get: libgpgme-dev libbtrfs-dev libdevmapper-dev

    - name: Set-up
      run: |
        mkdir -p $HOME/go/bin
        make operator-sdk

    - name: Ensure autogenerated stuff is in the best possible shape
      run: |
        export PATH=$HOME/go/bin:$PATH
        make manifests generate
        make bundle
        rm deploy/falcon-operator.yaml && make deploy/falcon-operator.yaml
        find ./bundle* -type f -exec sed -i -e 's/operator-sdk-v1.16.0+git/operator-sdk-v1.17.0/g' {} \;

        if [[ -n $(git status -s) ]] ; then
          echo "Generating manifests leaves tracked fields in a modified state."
          echo "Ensure to include updated manifests in this PR."
          echo "This is usually done by running 'make manifests generate' and running 'git add ...' for the files that was modified by generating manifests."
          git status -s
          git diff
          exit 1
        fi

    - name: Ensure go modules are tidy
      run: |
        go mod tidy
        if [[ -n $(git status -s) ]] ; then
          echo "Running 'go mod tidy' changes the current settinng"
          echo "Ensure to include updated go.mod and go.sum in this PR."
          echo "This is usually done by running 'go mod tidy'"
          git status -s
          git diff
          exit 1
        fi

    - name: Ensure go fmt is clean
      run: |
        make fmt
        if [[ -n $(git status -s) ]] ; then
          echo "Running 'make fmt' changes the current codebase"
          echo "Ensure to include updated codebase in this PR."
          echo "This is usually done by running 'make fmt'"
          git status -s
          git diff
          exit 1
        fi
